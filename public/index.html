<html>
	<head>
		<script src="/socket.io/socket.io.js"></script>
	</head>
	<body style="background: lightgray;">
		<div style="width: 810px;height: 610px;padding: 5px;margin: 20px auto 0; background: white; border: 1px solid black;">
			<canvas width="800" height="600" style="width: 800px; height: 600px;outline:none;"></canvas>
		</div>

		<script>
			var socket = io();

			var entities = [];
			var blocks = [];

			var canvas = document.getElementsByTagName('canvas')[0];
			let ctx = canvas.getContext('2d');

			const render = () => {
				ctx.clearRect(0, 0, canvas.width, canvas.height);

				entities.forEach((p, i) => {
					ctx.beginPath();
					ctx.arc(p.location.x, p.location.y, 10, 0, 2 * Math.PI);
					ctx.closePath();
					ctx.stroke();
				});

				blocks.forEach((b, i) => {
					ctx.beginPath();
					ctx.rect(b.x, b.y, b.w, b.h);
					ctx.closePath();
					ctx.stroke();
				});

				window.requestAnimationFrame(render);
			};

			window.requestAnimationFrame(render);

			// enable keyboard events
			canvas.setAttribute('tabindex', 0);

			// ignore repeated key events
			var direction = { x: 0, y: 0 };
			canvas.addEventListener('keydown', (event) => {
				// console.log("keydown", event);
				var change = false;
				switch (event.key)
				{
					case 'ArrowUp':
					{
						if (direction.y !== -1)
						{
							direction.y = -1;
							change = true;
						}
						break;
					}
					case 'ArrowDown':
					{
						if (direction.y !== 1)
						{
							direction.y = 1;
							change = true;
						}
						break;
					}
					case 'ArrowLeft':
					{
						if (direction.x !== -1)
						{
							direction.x = -1;
							change = true;
						}
						break;
					}
					case 'ArrowRight':
					{
						if (direction.x !== 1)
						{
							direction.x = 1;
							change = true;
						}
						break;
					}
				}

				if (change)
				{
					socket.emit('move', direction);
				}
			});
			canvas.addEventListener('keyup', (event) => {
				// console.log("keyup", event);
				var change = false;
				switch (event.key)
				{
					case 'ArrowUp':/*
					{
						if (direction.y !== 0)
						{
							direction.y = 0;
							change = true;
						}
						break;
					}*/
					case 'ArrowDown':
					{
						if (direction.y !== 0)
						{
							direction.y = 0;
							change = true;
						}
						break;
					}
					case 'ArrowLeft':/*
					{
						if (direction.x !== -1)
						{
							direction.x = -1;
							change = true;
						}
						break;
					}*/
					case 'ArrowRight':
					{
						if (direction.x !== 0)
						{
							direction.x = 0;
							change = true;
						}
						break;
					}
				}

				if (change)
				{
					socket.emit('move', direction);
				}
			});

			socket.on('spawn', (msg) => {
				entities.push(msg);
				console.log("Player spawned", msg);
			});

			socket.on('arena', (msg) => {
				console.log("Loading arena");
				entities = msg.players;
				blocks = msg.arena.blocks;
			});

			socket.on('players', (msg) => {
				console.log("Updating players");
				entities = msg;
			});

			socket.on('destroy', (msg) => {
				let index = entities.findIndex((e) => {
					return e.id === msg.id;
				});

				console.log("Player destroyed", entities[index]);

				if (-1 !== index)
				{
					entities.splice(index, 1);
				}
			});
		</script>
	</body>
</html>
